#!/bin/bash -e

export NOMAD_ADDR=http://10.42.2.1:4646
borg_repo=/opt/volumes/borg
time=$(date +%Y-%m-%dT%H:%M:%S)

function nomad_alloc() {
  curl -s $NOMAD_ADDR/v1/job/$1/allocations \
    | jq '.[] | select(.TaskGroup == "'$2'") .ID' -r
}

function borg_create() {
  archive_name=acs-$1-$time
  pv | borg create $borg_repo::$archive_name -
  echo "ðŸ’¾ $1"
}

(
  alloc=$(nomad_alloc acs-interface database)
  nomad exec -t=false $alloc \
    bash -c 'pg_dump -Ox -U $POSTGRES_USER interface' \
    | borg_create interface-database
)

(
  alloc=$(nomad_alloc acs-interface storage)
  nomad exec -t=false $alloc \
    tar c -C / data \
    | borg_create interface-storage
)

(
  alloc=$(nomad_alloc vmck database)
  nomad exec -t=false $alloc \
    bash -c 'pg_dump -Ox -U $POSTGRES_USER vmck' \
    | borg_create vmck-database
)

echo "âœ”Â acs backup successful!"

# to recover:
#   borg extract --stdout $borg_repo::$backup_name
